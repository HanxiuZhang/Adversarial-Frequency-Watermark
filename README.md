## A Method for Applying Gradient Attack through Frequency Domain Watermarking
The reference code for the paper "Making Adversarial Attack Imperceptible in Frequency Domain: A Watermark-based Framework" (ICME 2023).\\

In the preliminary experiments, the following observations were made:

- Directly applying gradient interference to images with added electronic watermarks may cause unpredictable disruptions to the extraction of the watermark.
- Optimization-based attack methods can alleviate the above issue to some extent due to image quality constraints, but their attack effectiveness is not as strong as gradient attacks.

A novel method is proposed to apply gradient attacks through frequency domain watermarking, which is characterized by the following points:

- Instead of directly applying gradient attacks to the original image, the method alters the electronic watermark added to the image.
- It can be used in scenarios where the original image cannot be changed but the electronic watermark can be modified.
- It allows control over the extraction effect of the watermark while achieving attack effectiveness similar to gradient attacks.
- It can be seamlessly integrated with any given gradient-based attack method.

### Watermark Addition Process
Let the original image be denoted as $I$, and the original watermark as $W$, both having the same size.
1. Divide $I$ into blocks of size $n \times n$ for each channel.
2. Perform discrete cosine transform (DCT) on each block of $I$ to obtain the frequency domain image $I'$.
$$I' = F_{DCT}(I)$$
3. Overlay the watermark $W$ on the frequency domain image with a strength $\alpha$, resulting in the overlaid frequency domain image $I'_W$.
$$I'_W = I' + \alpha W$$
4. Divide $I'_ W$ into blocks and perform inverse DCT to obtain the image $I_W$ with the frequency domain watermark applied:
$$I_W = F_{IDCT}(I'_W)$$

The process can be represented as follows:
$$I_W = F(I, W)$$

### Model Derivation
For the method that directly applies gradient attacks after watermark addition, it can be expressed as:
$$I_{per} = I_W + \beta P$$
Where $P$ represents the gradient interference calculated using a gradient-based attack method (e.g., FGSM/PGD).
Let $\hat{I_{per}}$ be the adversarial sample generated by adding perturbations $P_W$ to the watermark, then:
$$\hat{I_{per}} = F(I, W + P_W)$$
To make $\hat{I_{per}}$ effective as an adversarial sample, we set:
$$\hat{I_{per}} = I_{per}$$
Thus,
$$F(I, W + P_W) = F(I, W) + \beta P$$
$$F_{IDCT}(F_{DCT}(I) + \alpha (W + P_W)) = F_{IDCT}(F_{DCT}(I) + \alpha W) + \beta P$$
Given that:
$$F_{DCT}(F_{IDCT}(x)) = x$$
and the linearity property of Fourier transform, we can derive:
$$F_{DCT}(I) + \alpha W + \alpha P_W = F_{DCT}(I) + \alpha W + \beta F_{DCT}(P)$$
$$P_W = \frac{\beta}{\alpha} F_{DCT}(P)$$
It can be observed that when $\alpha \gg \beta$, the perturbation $P_W$ applied to the watermark will be sufficiently small.

### Method Flow
Given a model $M$, an image $I$, and its corresponding label $T$ (for targeted attacks, an attack label $T'$ is given):

1. Use a gradient-based attack method to generate the gradient perturbation $P$.
2. Determine the parameter $\beta$ such that $M(\text{clip}(I + \beta P)) \ne T$ (for targeted attacks: $M(\text{clip}(I + \beta P)) = T'$).
3. Perform block-wise DCT on $P$ to obtain $F_{DCT}(P)$.
4. Determine the parameter $\alpha$ to ensure that $\frac{\beta}{\alpha}$ is sufficiently small to keep the perturbation $P_W$ on the watermark small, while ensuring the image quality after adding the watermark. Obtain the adversarial perturbation applied to the electronic watermark:
$$P_W = \frac{\beta}{\alpha} F_{DCT}(P)$$
5. Compute the adversarial sample with the generated electronic watermark:
$$W_{per} = \text{clip}(W + P_W)$$

The optimization problem for the parameters $\alpha$ and $\beta$ is as follows:
$$\min_{\alpha, \beta \in D} L$$

subject toï¼š
$$M(\text{clip}(F(I, \text{clip}(W + P_W)))) \ne T$$

Where:
- $D$ is the feasible set for $\alpha$ and $\beta$.
- $L_I = \lVert I_W - I \rVert_2^2$ represents the quality loss in the host image.
- $L_W = \lVert P_W \rVert_2^2$ represents the quality loss in the watermark image.
- $L = \lambda_1 L_I + \lambda_2 L_W$ is the overall loss function with weighting coefficients $\lambda_1$ and $\lambda_2$.
- The optimization aims to find appropriate $\alpha$ and $\beta$ that satisfy the constraints while minimizing the loss $L$.
